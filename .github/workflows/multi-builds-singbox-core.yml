name: Update sing-box
on:
  workflow_dispatch:
  schedule:
    - cron: "0 */6 * * *"
  push:
    branches:
      - main
    paths-ignore:
      - "README.md"
      - ".github/workflows/delete-old-workflows.yml"
      - ".github/workflows/update-dashboard.yml"

jobs:
  go:
    runs-on: ubuntu-latest
    outputs:
      go_version: ${{ steps.go.outputs.version }}
    steps:
      - name: Get `Go` latest version
        id: go
        run: |
          echo "version=$(curl -sSL https://raw.githubusercontent.com/actions/go-versions/update-versions-manifest-file/versions-manifest.json | jq -r '.[0].version')" >> $GITHUB_OUTPUT
  puernya:
    runs-on: ubuntu-latest
    needs: go
    outputs:
      puernya_version: ${{ steps.puernya.outputs.puernya_version }}
      puernya_time: ${{ steps.puernya.outputs.puernya_time }}
      puernya_tags: ${{ steps.puernya.outputs.puernya_tags }}
      puernya_skip_update: ${{ steps.compare.outputs.skip_update }}
    steps:
      - name: Checkout `building`
        uses: actions/checkout@v6
        with:
          repository: PuerNya/sing-box
          ref: building
          fetch-depth: 0

      - name: Setup `Go`
        uses: actions/setup-go@v6
        with:
          go-version: ${{ needs.go.outputs.go_version }}

      - name: Get `sing-box PuerNya` version
        id: puernya
        run: |
          git remote add sekai https://github.com/SagerNet/sing-box.git
          git fetch --tags sekai
          puernya_version=$(CGO_ENABLED=0 go run ./cmd/internal/read_tag)
          ver_commit=$(echo "${puernya_version}" | awk -F '-' '{print $3}')
          puernya_time=$(git log -1 --format=%cd --date=format:'%Y-%m-%d' "$ver_commit")
          echo "puernya_version=$puernya_version" >> $GITHUB_OUTPUT
          echo "puernya_time=$puernya_time" >> $GITHUB_OUTPUT
          echo "puernya_tags=with_quic,with_dhcp,with_wireguard,with_shadowsocksr,with_ech,with_utls,with_clash_api,with_gvisor" >> $GITHUB_OUTPUT

      - name: Compare `sing-box PuerNya` versions with current release
        id: compare
        run: |
          current_body=$(curl -sSL "https://api.github.com/repos/${{ github.repository }}/releases/tags/sing-box" | jq -r '.body // ""')
          if echo "$current_body" | grep -q "${{ steps.puernya.outputs.puernya_version }}.*${{ steps.puernya.outputs.puernya_time }}"; then
            echo "å½“å‰ sing-box PuerNya ç‰ˆæœ¬å·²æ˜¯æœ€æ–°ç‰ˆæœ¬ ${{ steps.puernya.outputs.puernya_version }}ï¼Œæ— éœ€æ›´æ–°"
            skip_update=true
          else
            echo "å½“å‰ sing-box PuerNya ç‰ˆæœ¬è¾ƒä½ï¼Œéœ€è¦æ›´æ–°æœ€æ–°ç‰ˆæœ¬è‡³ ${{ steps.puernya.outputs.puernya_version }}"
            skip_update=false
          fi
          echo "skip_update=$skip_update" >> $GITHUB_OUTPUT

  puernya_cross:
    runs-on: ubuntu-latest
    if: ${{ needs.puernya.outputs.puernya_skip_update != 'true' }}
    strategy:
      matrix:
        include:
          # linux
          - { name: linux-amd64, goos: linux, goarch: amd64, goamd64: v1 }
          - { name: linux-armv7, goos: linux, goarch: arm, goarm: 7 }
          - { name: linux-arm64, goos: linux, goarch: arm64 }
          # windows
          - { name: windows-amd64, goos: windows, goarch: amd64, goamd64: v1 }
          - { name: windows-arm64, goos: windows, goarch: arm64 }

      fail-fast: false
    needs:
      - go
      - puernya
    env:
      GOOS: ${{ matrix.goos }}
      GOARCH: ${{ matrix.goarch }}
      GOAMD64: ${{ matrix.goamd64 }}
      GOARM: ${{ matrix.goarm }}
      GOMIPS: ${{ matrix.gomips }}
      CGO_ENABLED: 0
      puernya_VERSION: ${{ needs.puernya.outputs.puernya_version }}
      puernya_TAGS: ${{ needs.puernya.outputs.puernya_tags }}
    steps:
      - name: Checkout `building`
        uses: actions/checkout@v6
        with:
          repository: PuerNya/sing-box
          ref: building

      - name: Fix sniff
        run: sed -i 's/sniffHosts/sniffHost/' ./experimental/clashapi/trafficontrol/tracker.go

      - name: Setup `Go`
        uses: actions/setup-go@v6
        with:
          go-version: ${{ needs.go.outputs.go_version }}

      - name: Build `sing-box PuerNya` core
        id: build
        run: go build -v -trimpath -ldflags "-checklinkname=0 -X 'github.com/sagernet/sing-box/constant.Version=${puernya_VERSION}' -s -w -buildid=" -tags "${puernya_TAGS}" ./cmd/sing-box

      - name: Upload files to workspace
        uses: actions/upload-artifact@v6
        with:
          name: sing-box-puernya-${{ matrix.name }}
          path: sing-box*
  ref1nd-main:
    runs-on: ubuntu-latest
    needs: go
    outputs:
      ref1nd_main_version: ${{ steps.ref1nd_main.outputs.ref1nd_main_version }}
      ref1nd_main_time: ${{ steps.ref1nd_main.outputs.ref1nd_main_time }}
      ref1nd_main_tags: ${{ steps.ref1nd_main.outputs.ref1nd_main_tags }}
      ref1nd_main_skip_update: ${{ steps.compare.outputs.skip_update }}
    steps:
      - name: Checkout `reF1nd-main`
        uses: actions/checkout@v6
        with:
          repository: reF1nd/sing-box
          ref: reF1nd-main
          fetch-depth: 0

      - name: Setup `Go`
        uses: actions/setup-go@v6
        with:
          go-version: ${{ needs.go.outputs.go_version }}

      - name: Get `sing-box reF1nd-main` version
        id: ref1nd_main
        run: |
          git remote add sekai https://github.com/SagerNet/sing-box.git
          git fetch --tags sekai
          echo "ref1nd_main_version=$(git tag -l --sort=v:refname | grep -Po '^v?\K[0-9]+\.[0-9]+\.[0-9]+$' | tail -n1)" >> $GITHUB_OUTPUT
          echo "ref1nd_main_time=$(git log -1 --format=%cd --date=format:'%Y-%m-%d' $(echo "$ref1nd_main_version" | awk -F '-' '{print $3}'))" >> $GITHUB_OUTPUT
          echo "ref1nd_main_tags=with_gvisor,with_quic,with_dhcp,with_wireguard,with_utls,with_acme,with_clash_api,with_tailscale" >> $GITHUB_OUTPUT

      - name: Compare `sing-box reF1nd-main` versions with current release
        id: compare
        run: |
          current_body=$(curl -sSL "https://api.github.com/repos/${{ github.repository }}/releases/tags/sing-box" | jq -r '.body // ""')
          arch="sing-box reF1nd-main|${{ steps.ref1nd_main.outputs.ref1nd_main_version }}|${{ steps.ref1nd_main.outputs.ref1nd_main_time }}"
          IFS="|" read -r name version time <<< "$arch"
          if echo "${current_body}" | grep -q "${name}.*${version}.*${time}"; then
            echo "å½“å‰ ${name} ç‰ˆæœ¬å·²æ˜¯æœ€æ–°ç‰ˆæœ¬ v${version}ï¼Œæ— éœ€æ›´æ–°"
            skip_update=true
          else
            echo "å½“å‰ ${name} ç‰ˆæœ¬è¾ƒä½ï¼Œéœ€è¦æ›´æ–°æœ€æ–°ç‰ˆæœ¬è‡³ v${version}"
            skip_update=false
          fi
          echo "skip_update=$skip_update" >> $GITHUB_OUTPUT

  ref1nd-main_cross:
    runs-on: ubuntu-latest
    if: ${{ needs.ref1nd-main.outputs.ref1nd_main_skip_update != 'true' }}
    strategy:
      matrix:
        include:
          # linux
          - { name: linux-amd64-v1, goos: linux, goarch: amd64, goamd64: v1 }
          - { name: linux-amd64-v3, goos: linux, goarch: amd64, goamd64: v3 }
          - { name: linux-armv7, goos: linux, goarch: arm, goarm: 7 }
          - { name: linux-arm64, goos: linux, goarch: arm64 }
          # windows
          - { name: windows-amd64-v1, goos: windows, goarch: amd64, goamd64: v1 }
          - { name: windows-amd64-v3, goos: windows, goarch: amd64, goamd64: v3 }
          - { name: windows-arm64, goos: windows, goarch: arm64 }

      fail-fast: false
    needs:
      - go
      - ref1nd-main
    env:
      GOOS: ${{ matrix.goos }}
      GOARCH: ${{ matrix.goarch }}
      GOAMD64: ${{ matrix.goamd64 }}
      GOARM: ${{ matrix.goarm }}
      GOMIPS: ${{ matrix.gomips }}
      CGO_ENABLED: 0
      ref1nd_main_VERSION: ${{ needs.ref1nd-main.outputs.ref1nd_main_version }}
      ref1nd_main_TAGS: ${{ needs.ref1nd-main.outputs.ref1nd_main_tags }}
    steps:
      - name: Checkout `reF1nd-main`
        uses: actions/checkout@v6
        with:
          repository: reF1nd/sing-box
          ref: reF1nd-main

      - name: Setup `Go`
        uses: actions/setup-go@v6
        with:
          go-version: ${{ needs.go.outputs.go_version }}

      - name: Build `sing-box reF1nd-main` core
        id: build
        run: go build -v -trimpath -ldflags "-checklinkname=0 -X 'github.com/sagernet/sing-box/constant.Version=${ref1nd_main_VERSION}' -s -w -buildid=" -tags "${ref1nd_main_TAGS}" ./cmd/sing-box

      - name: Upload files to workspace
        uses: actions/upload-artifact@v6
        with:
          name: sing-box-ref1nd-main-${{ matrix.name }}
          path: sing-box*

  ref1nd-dev:
    runs-on: ubuntu-latest
    needs: go
    outputs:
      ref1nd_dev_version: ${{ steps.ref1nd_dev.outputs.ref1nd_dev_version }}
      ref1nd_dev_time: ${{ steps.ref1nd_dev.outputs.ref1nd_dev_time }}
      ref1nd_dev_tags: ${{ steps.ref1nd_dev.outputs.ref1nd_dev_tags }}
      ref1nd_dev_skip_update: ${{ steps.compare.outputs.skip_update }}
    steps:
      - name: Checkout `reF1nd-dev`
        uses: actions/checkout@v6
        with:
          repository: reF1nd/sing-box
          ref: reF1nd-dev
          fetch-depth: 0

      - name: Setup `Go`
        uses: actions/setup-go@v6
        with:
          go-version: ${{ needs.go.outputs.go_version }}

      - name: Get `sing-box reF1nd-dev` version
        id: ref1nd_dev
        run: |
          git remote add sekai https://github.com/SagerNet/sing-box.git
          git fetch --tags sekai
          echo "ref1nd_dev_version=$(git tag -l --sort=v:refname | grep -Po '^v\K.*(alpha|beta|rc).*' | tail -n1)" >> $GITHUB_OUTPUT
          echo "ref1nd_dev_time=$(git log -1 --format=%cd --date=format:'%Y-%m-%d' $(echo "$ref1nd_dev_version" | awk -F '-' '{print $3}'))" >> $GITHUB_OUTPUT
          echo "ref1nd_dev_tags=with_gvisor,with_quic,with_dhcp,with_wireguard,with_utls,with_acme,with_clash_api,with_tailscale,with_ccm,badlinkname,tfogo_checklinkname0" >> $GITHUB_OUTPUT

      - name: Compare `sing-box reF1nd-dev` versions with current release
        id: compare
        run: |
          current_body=$(curl -sSL "https://api.github.com/repos/${{ github.repository }}/releases/tags/sing-box" | jq -r '.body // ""')
          arch="sing-box reF1nd-dev|${{ steps.ref1nd_dev.outputs.ref1nd_dev_version }}|${{ steps.ref1nd_dev.outputs.ref1nd_dev_time }}"
          IFS="|" read -r name version time <<< "$arch"
          if echo "${current_body}" | grep -q "${name}.*${version}.*${time}"; then
            echo "å½“å‰ ${name} ç‰ˆæœ¬å·²æ˜¯æœ€æ–°ç‰ˆæœ¬ v${version}ï¼Œæ— éœ€æ›´æ–°"
            skip_update=true
          else
            echo "å½“å‰ ${name} ç‰ˆæœ¬è¾ƒä½ï¼Œéœ€è¦æ›´æ–°æœ€æ–°ç‰ˆæœ¬è‡³ v${version}"
            skip_update=false
          fi
          echo "skip_update=$skip_update" >> $GITHUB_OUTPUT

  ref1nd-dev_cross:
    runs-on: ubuntu-latest
    if: ${{ needs.ref1nd-dev.outputs.ref1nd_dev_skip_update != 'true' }}
    strategy:
      matrix:
        include:
          # linux
          - { name: linux-amd64-v1, goos: linux, goarch: amd64, goamd64: v1 }
          - { name: linux-amd64-v3, goos: linux, goarch: amd64, goamd64: v3 }
          - { name: linux-armv7, goos: linux, goarch: arm, goarm: 7 }
          - { name: linux-arm64, goos: linux, goarch: arm64 }
          # windows
          - { name: windows-amd64-v1, goos: windows, goarch: amd64, goamd64: v1 }
          - { name: windows-amd64-v3, goos: windows, goarch: amd64, goamd64: v3 }
          - { name: windows-arm64, goos: windows, goarch: arm64 }

      fail-fast: false
    needs:
      - go
      - ref1nd-dev
    env:
      GOOS: ${{ matrix.goos }}
      GOARCH: ${{ matrix.goarch }}
      GOAMD64: ${{ matrix.goamd64 }}
      GOARM: ${{ matrix.goarm }}
      GOMIPS: ${{ matrix.gomips }}
      CGO_ENABLED: 0
      ref1nd_dev_VERSION: ${{ needs.ref1nd-dev.outputs.ref1nd_dev_version }}
      ref1nd_dev_TAGS: ${{ needs.ref1nd-dev.outputs.ref1nd_dev_tags }}
    steps:
      - name: Checkout `reF1nd-dev`
        uses: actions/checkout@v6
        with:
          repository: reF1nd/sing-box
          ref: reF1nd-dev

      - name: Setup `Go`
        uses: actions/setup-go@v6
        with:
          go-version: ${{ needs.go.outputs.go_version }}

      - name: Build `sing-box reF1nd-dev` core
        id: build
        run: go build -v -trimpath -ldflags "-checklinkname=0 -X 'github.com/sagernet/sing-box/constant.Version=${ref1nd_dev_VERSION}' -s -w -buildid=" -tags "${ref1nd_dev_TAGS}" ./cmd/sing-box

      - name: Upload files to workspace
        uses: actions/upload-artifact@v6
        with:
          name: sing-box-ref1nd-dev-${{ matrix.name }}
          path: sing-box*

  push_sing-box:
    runs-on: ubuntu-latest
    if: always()
    needs:
      - ref1nd-main
      - ref1nd-main_cross
      - ref1nd-dev
      - ref1nd-dev_cross
      - puernya
      - puernya_cross
    env:
      ref1nd_main_VERSION: ${{ needs.ref1nd-main.outputs.ref1nd_main_version }}
      ref1nd_main_TIME: ${{ needs.ref1nd-main.outputs.ref1nd_main_time }}
      ref1nd_dev_VERSION: ${{ needs.ref1nd-dev.outputs.ref1nd_dev_version }}
      ref1nd_dev_TIME: ${{ needs.ref1nd-dev.outputs.ref1nd_dev_time }}
      puernya_VERSION: ${{ needs.puernya.outputs.puernya_version }}
      puernya_TIME: ${{ needs.puernya.outputs.puernya_time }}
    steps:
      - name: Clone Repository
        uses: actions/checkout@v6

      - name: Download files from workspace
        uses: actions/download-artifact@v7
        with:
          path: ./tmp-ref1nd/

      - name: Move files and zip `sing-box reF1nd-main` cores by `tar`
        if: ${{ needs.ref1nd-main.outputs.ref1nd_main_skip_update != 'true' }}
        run: |
          # Linux
          mkdir -p ./tmp-ref1nd/ ./sing-box/
          linux_old_name=(amd64-v1 amd64-v3 armv7 arm64)
          linux_new_name=(amd64v1 amd64v3 armv7 armv8)
          for i in "${!linux_old_name[@]}"; do
            mv -f "./tmp-ref1nd/sing-box-ref1nd-main-linux-${linux_old_name[i]}/sing-box" ./tmp-ref1nd/sing-box
            chmod +x ./tmp-ref1nd/sing-box
            tar --no-same-owner -czf "./sing-box/sing-box-ref1nd-main-linux-${linux_new_name[i]}.tar.gz" -C ./tmp-ref1nd/ sing-box
          done

          # Windows
          windows_old_name=(amd64-v1 amd64-v3 arm64)
          windows_new_name=(amd64v1 amd64v3 arm64)
          for i in "${!windows_old_name[@]}"; do
            mv -f "./tmp-ref1nd/sing-box-ref1nd-main-windows-${windows_old_name[i]}/sing-box.exe" "./sing-box/sing-box-ref1nd-main-windows-${windows_new_name[i]}.exe"
          done

      - name: Move files and zip `sing-box reF1nd-dev` cores by `tar`
        if: ${{ needs.ref1nd-dev.outputs.ref1nd_dev_skip_update != 'true' }}
        run: |
          # Linux
          mkdir -p ./tmp-ref1nd/ ./sing-box/
          linux_old_name=(amd64-v1 amd64-v3 armv7 arm64)
          linux_new_name=(amd64v1 amd64v3 armv7 armv8)
          for i in "${!linux_old_name[@]}"; do
            mv -f "./tmp-ref1nd/sing-box-ref1nd-dev-linux-${linux_old_name[i]}/sing-box" ./tmp-ref1nd/sing-box
            chmod +x ./tmp-ref1nd/sing-box
            tar --no-same-owner -czf "./sing-box/sing-box-ref1nd-dev-linux-${linux_new_name[i]}.tar.gz" -C ./tmp-ref1nd/ sing-box
          done

          # Windows
          windows_old_name=(amd64-v1 amd64-v3 arm64)
          windows_new_name=(amd64v1 amd64v3 arm64)
          for i in "${!windows_old_name[@]}"; do
            mv -f "./tmp-ref1nd/sing-box-ref1nd-dev-windows-${windows_old_name[i]}/sing-box.exe" "./sing-box/sing-box-ref1nd-dev-windows-${windows_new_name[i]}.exe"
          done

      - name: Move files and zip `sing-box PuerNya` cores by `tar`
        if: ${{ needs.puernya.outputs.puernya_skip_update != 'true' }}
        run: |
          # Linux
          mkdir -p ./tmp-ref1nd/tmp-puernya/ ./sing-box/
          archs=(amd64 armv7 arm64)
          for arch in "${archs[@]}"; do
            mv -f "./tmp-ref1nd/sing-box-puernya-linux-${arch}/sing-box" ./tmp-ref1nd/tmp-puernya/sing-box
            chmod +x ./tmp-ref1nd/tmp-puernya/sing-box
            tar --no-same-owner -czf "./sing-box/sing-box-puernya-linux-${arch}.tar.gz" -C ./tmp-ref1nd/tmp-puernya/ sing-box
          done

          # Windows
          mv -f ./tmp-ref1nd/sing-box-puernya-windows-amd64/sing-box.exe ./sing-box/sing-box-puernya-windows-amd64.exe
          mv -f ./tmp-ref1nd/sing-box-puernya-windows-arm64/sing-box.exe ./sing-box/sing-box-puernya-windows-arm64.exe
          rm -rf ./tmp-ref1nd/*

      - name: Set variables
        run: |
          echo "download_url=https://github.com/SagerNet/sing-box/releases/download" >> ${GITHUB_ENV}
          echo "release_version=$(curl -sSL https://api.github.com/repos/SagerNet/sing-box/releases/latest | jq -r '.tag_name')" >> ${GITHUB_ENV}
          echo "release_time=$(curl -sSL https://api.github.com/repos/SagerNet/sing-box/releases/latest | jq -r '.created_at' | xargs -I {} date -d '{} +8 hours' '+%Y-%m-%d')" >> ${GITHUB_ENV}
          echo "dev_version=$(curl -sSL https://api.github.com/repos/SagerNet/sing-box/releases | jq -r '[.[] | select(.tag_name | test("alpha|beta|rc"))][0].tag_name')" >> ${GITHUB_ENV}
          echo "dev_time=$(curl -sSL https://api.github.com/repos/SagerNet/sing-box/releases | jq -r '[.[] | select(.tag_name | test("alpha|beta|rc"))][0].created_at' | xargs -I {} date -d '{} +8 hours' '+%Y-%m-%d')" >> ${GITHUB_ENV}
        shell: bash

      - name: Compare `sing-box` versions with current release
        run: |
          current_body=$(curl -sSL "https://api.github.com/repos/${{ github.repository }}/releases/tags/sing-box" | jq -r '.body // ""')
          archs=(
            "sing-box Release|${release_version}|${release_time}"
            "sing-box Dev|${dev_version}|${dev_time}"
          )
          for arch in "${archs[@]}"; do
            IFS="|" read -r name version time <<< "$arch"
            var_name="${name//[ -]/_}_skip_update"
            if echo "${current_body}" | grep -q "${name}.*${version}.*${time}"; then
              echo "å½“å‰ ${name} ç‰ˆæœ¬å·²æ˜¯æœ€æ–°ç‰ˆæœ¬ ${version}ï¼Œæ— éœ€æ›´æ–°"
              eval "${var_name}=true"
            else
              echo "å½“å‰ ${name} ç‰ˆæœ¬è¾ƒä½ï¼Œéœ€è¦æ›´æ–°æœ€æ–°ç‰ˆæœ¬è‡³ ${version}"
              eval "${var_name}=false"
            fi
            eval "value=\$${var_name}"
            echo "${var_name}=${value}" >> ${GITHUB_ENV}
          done

      - name: Download `sing-box Release` files
        if: ${{ env.sing_box_Release_skip_update != 'true' }}
        run: |
          # Linux
          mkdir -p ./sing-box/
          linux_old_name=(amd64 armv7 arm64)
          linux_new_name=(amd64 armv7 armv8)
          for i in "${!linux_old_name[@]}"; do
            mkdir -p "./tmp-release/release_linux_${linux_old_name[i]}"
            curl -L "${download_url}/${release_version}/sing-box-${release_version#v}-linux-${linux_old_name[i]}.tar.gz" | tar -zx -C "./tmp-release/release_linux_${linux_old_name[i]}/"
            mv -f "./tmp-release/release_linux_${linux_old_name[i]}/sing-box-${release_version#v}-linux-${linux_old_name[i]}/sing-box" ./tmp-release/sing-box
            chmod +x ./tmp-release/sing-box
            tar --no-same-owner -czf "./sing-box/sing-box-release-linux-${linux_new_name[i]}.tar.gz" -C ./tmp-release/ sing-box
          done

          # Windows
          archs=(amd64 arm64)
          for arch in "${archs[@]}"; do
            mkdir -p "./tmp-release/release_windows_${arch}"
            wget -P "./tmp-release/release_windows_${arch}/" "${download_url}/${release_version}/sing-box-${release_version#v}-windows-${arch}.zip"
            unzip -o "./tmp-release/release_windows_${arch}/sing-box-${release_version#v}-windows-${arch}.zip" -d "./tmp-release/release_windows_${arch}/"
            mv -f "./tmp-release/release_windows_${arch}/sing-box-${release_version#v}-windows-${arch}/sing-box.exe" "./sing-box/sing-box-release-windows-${arch}.exe"
          done
          rm -rf ./tmp-release*

      - name: Download `sing-box Dev` files
        if: ${{ env.sing_box_Dev_skip_update != 'true' }}
        run: |
          # Linux
          mkdir -p ./sing-box/
          linux_old_name=(amd64 armv7-musl arm64)
          linux_new_name=(amd64 armv7 armv8)
          for i in "${!linux_old_name[@]}"; do
            mkdir -p "./tmp-dev/dev_linux_${linux_old_name[i]}"
            curl -L "${download_url}/${dev_version}/sing-box-${dev_version#v}-linux-${linux_old_name[i]}.tar.gz" | tar -zx -C "./tmp-dev/dev_linux_${linux_old_name[i]}/"
            mv -f "./tmp-dev/dev_linux_${linux_old_name[i]}/sing-box-${dev_version#v}-linux-${linux_old_name[i]}/sing-box" ./tmp-dev/sing-box
            chmod +x ./tmp-dev/sing-box
            tar --no-same-owner -czf "./sing-box/sing-box-dev-linux-${linux_new_name[i]}.tar.gz" -C ./tmp-dev/ sing-box
          done

          # Windows
          archs=(amd64 arm64)
          for arch in "${archs[@]}"; do
            mkdir -p "./tmp-dev/dev_windows_${arch}"
            wget -P "./tmp-dev/dev_windows_${arch}/" "${download_url}/${dev_version}/sing-box-${dev_version#v}-windows-${arch}.zip"
            unzip -o "./tmp-dev/dev_windows_${arch}/sing-box-${dev_version#v}-windows-${arch}.zip" -d "./tmp-dev/dev_windows_${arch}/"
            mv -f "./tmp-dev/dev_windows_${arch}/sing-box-${dev_version#v}-windows-${arch}/sing-box.exe" "./sing-box/sing-box-dev-windows-${arch}.exe"
          done
          rm -rf ./tmp-dev*

      - name: Check if `sing-box` files exist
        id: check
        run: |
          if ls ./sing-box/* >/dev/null 2>&1; then
            echo "sing-box æ–‡ä»¶å¤¹å†…å­˜åœ¨æ–°å†…æ ¸æ–‡ä»¶ï¼Œéœ€è¦ä¸Šä¼ "
            echo "singbox_exist=true" >> $GITHUB_OUTPUT
          else
            echo "sing-box æ–‡ä»¶å¤¹å†…æ²¡æœ‰æ–°å†…æ ¸æ–‡ä»¶ï¼Œæ— éœ€ä¸Šä¼ "
            echo "singbox_exist=false" >> $GITHUB_OUTPUT
          fi

      - name: Release and upload `sing-box` assets
        if: ${{ steps.check.outputs.singbox_exist == 'true' }}
        uses: svenstaro/upload-release-action@v2
        with:
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          release_name: sing-box
          tag: sing-box
          overwrite: true
          body: |
            # ğŸ“ Release Notes 
            1. æ›´æ–° [sing-box reF1nd-main ç‰ˆ](https://github.com/reF1nd/sing-box/tree/reF1nd-main)è‡³ v${{ env.ref1nd_main_VERSION }}ï¼Œå‘å¸ƒäº ${{ env.ref1nd_main_TIME }}
            2. æ›´æ–° [sing-box reF1nd-dev ç‰ˆ](https://github.com/reF1nd/sing-box/tree/reF1nd-dev)è‡³ v${{ env.ref1nd_dev_VERSION }}ï¼Œå‘å¸ƒäº ${{ env.ref1nd_dev_TIME }}
            3. æ›´æ–° [sing-box Release ç‰ˆ](https://github.com/SagerNet/sing-box/tree/main)è‡³ ${{ env.release_version }}ï¼Œå‘å¸ƒäº ${{ env.release_time }}
            4. æ›´æ–° [sing-box Dev ç‰ˆ](https://github.com/SagerNet/sing-box/tree/dev)è‡³ ${{ env.dev_version }}ï¼Œå‘å¸ƒäº ${{ env.dev_time }}
            5. æ›´æ–° [sing-box PuerNya ç‰ˆ](https://github.com/PuerNya/sing-box/tree/building) è‡³ v${{ env.puernya_VERSION }}ï¼Œå‘å¸ƒäº ${{ env.puernya_TIME }}
          file_glob: true
          file: ./sing-box/*

      - name: Set outputs for update_readme
        id: vars
        run: |
          echo "release_version=${release_version}" >> $GITHUB_OUTPUT
          echo "release_time=${release_time}" >> $GITHUB_OUTPUT
          echo "dev_version=${dev_version}" >> $GITHUB_OUTPUT
          echo "dev_time=${dev_time}" >> $GITHUB_OUTPUT
          echo "puernya_version=${puernya_VERSION}" >> $GITHUB_OUTPUT
          echo "puernya_time=${puernya_TIME}" >> $GITHUB_OUTPUT
          echo "ref1nd_main_version=${ref1nd_main_VERSION}" >> $GITHUB_OUTPUT
          echo "ref1nd_main_time=${ref1nd_main_TIME}" >> $GITHUB_OUTPUT
          echo "ref1nd_dev_version=${ref1nd_dev_VERSION}" >> $GITHUB_OUTPUT
          echo "ref1nd_dev_time=${ref1nd_dev_TIME}" >> $GITHUB_OUTPUT
    outputs:
      release_version: ${{ steps.vars.outputs.release_version }}
      release_time: ${{ steps.vars.outputs.release_time }}
      dev_version: ${{ steps.vars.outputs.dev_version }}
      dev_time: ${{ steps.vars.outputs.dev_time }}
      puernya_version: ${{ steps.vars.outputs.puernya_version }}
      puernya_time: ${{ steps.vars.outputs.puernya_time }}
      ref1nd_main_version: ${{ steps.vars.outputs.ref1nd_main_version }}
      ref1nd_main_time: ${{ steps.vars.outputs.ref1nd_main_time }}
      ref1nd_dev_version: ${{ steps.vars.outputs.ref1nd_dev_version }}
      ref1nd_dev_time: ${{ steps.vars.outputs.ref1nd_dev_time }}

  Update_Readme:
    runs-on: ubuntu-latest
    if: always()
    needs: [puernya, push_sing-box]
    steps:
      - name: Update README
        uses: mnjirjak/github-update-readme@v1.4.0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          puernya_VERSION: ${{ needs.push_sing-box.outputs.puernya_version }}
          puernya_TIME: ${{ needs.push_sing-box.outputs.puernya_time }}
          ref1nd_main_VERSION: ${{ needs.push_sing-box.outputs.ref1nd_main_version }}
          ref1nd_main_TIME: ${{ needs.push_sing-box.outputs.ref1nd_main_time }}
          ref1nd_dev_VERSION: ${{ needs.push_sing-box.outputs.ref1nd_dev_version }}
          ref1nd_dev_TIME: ${{ needs.push_sing-box.outputs.ref1nd_dev_time }}
          RELEASE_VERSION: ${{ needs.push_sing-box.outputs.release_version }}
          RELEASE_TIME: ${{ needs.push_sing-box.outputs.release_time }}
          DEV_VERSION: ${{ needs.push_sing-box.outputs.dev_version }}
          DEV_TIME: ${{ needs.push_sing-box.outputs.dev_time }}
        with:
          header: "Sing-Boxæ ¸å¿ƒç¼–è¯‘"
          repoCount: "0"
          subhead: |
            ## sing-box å†…æ ¸ PuerNya ç‰ˆ

            ```
            curl -L https://github.com/enpioodada/sing-box-core/releases/download/sing-box/sing-box-puernya-linux-amd64.tar.gz | tar -zx -C /usr/local/bin
            ```
            ## sing-box å†…æ ¸ reF1nd-main ç‰ˆ

            ```
            curl -L https://github.com/enpioodada/sing-box-core/releases/download/sing-box/sing-box-ref1nd-main-linux-amd64v3.tar.gz | tar -zx -C /usr/local/bin
            ```

            ## Changelog <br/>

            1. æ›´æ–° [sing-box PuerNya ç‰ˆ](https://github.com/PuerNya/sing-box/tree/building)è‡³ v${{ env.puernya_VERSION }}ï¼Œå‘å¸ƒäº ${{ env.puernya_TIME }} <br/>
            2. æ›´æ–° [sing-box reF1nd-main ç‰ˆ](https://github.com/reF1nd/sing-box/tree/reF1nd-main)è‡³ v${{ env.ref1nd_main_VERSION }}ï¼Œå‘å¸ƒäº ${{ env.ref1nd_main_TIME }} <br/>
            3. æ›´æ–° [sing-box reF1nd-dev ç‰ˆ](https://github.com/reF1nd/sing-box/tree/reF1nd-dev)è‡³ v${{ env.ref1nd_dev_VERSION }}ï¼Œå‘å¸ƒäº ${{ env.ref1nd_dev_TIME }} <br/>
            4. æ›´æ–° [sing-box Release ç‰ˆ](https://github.com/SagerNet/sing-box/tree/main)è‡³ ${{ env.RELEASE_VERSION }}ï¼Œå‘å¸ƒäº ${{ env.RELEASE_TIME }} <br/>
            5. æ›´æ–° [sing-box Dev ç‰ˆ](https://github.com/SagerNet/sing-box/tree/dev)è‡³ ${{ env.DEV_VERSION }}ï¼Œå‘å¸ƒäº ${{ env.DEV_TIME }}
